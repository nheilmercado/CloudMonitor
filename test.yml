trigger:
- RK-PowerBi-Deployment

parameters:
- name: ServiceConn
  displayName: ServiceConn
  type: string
  default: PROD-Connection2
- name: PowerBiServiceConn
  displayName: PowerBiServiceConn
  type: string
  default: Power-bi conn
- name: groupvariables
  type: object
  default:
   - CloudMonitorSentis


stages:

- stage: 'DeployDB'
  displayName: 'Deploy to SQL Database'
  pool:
    name: DevOpsBuildAgentProdWindowsPool
  jobs:
  - ${{ each group in parameters.groupvariables }}:
      - job:
        displayName: 'Deploy to SQL Database'
        variables:
        - name: sdkVersion
          value: initialValue 
        steps:
        
            - powershell: echo "##vso[task.setvariable variable=myOutputVar;isOutput=true]this is the value"
              name: setvarStep
            - script: echo $(setvarStep.myOutputVar)
              name: echovar
    
            - task: AzurePowerShell@5
              name: Updatecredentials
              inputs:
                azureSubscription: '${{ parameters.ServiceConn }}'
                ScriptType: 'InlineScript'
                Inline: |
                  Write-Host "$env:sdkVersion $env:PowerBiClientId $env:PowerBiClientSecretKey"
                  
                  $applicationId = $env:PowerBiClientId

                  $TenantId = $env:TENANTIDDD

                  $clientsec =  ConvertTo-SecureString -String $env:PowerBiClientSecretKey -AsPlainText -Force

                    $credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $applicationId, $clientsec

                    Connect-PowerBIServiceAccount -ServicePrincipal -Credential $credential -TenantId $TenantId
                    
                  $version1 = '7638c835-dbd4-49e4-ad77-3f890758f7f5'
                  
                  Write-Host "##vso[task.setvariable variable=sdkVersion;isOutput=true]$version1" 
                  
                  Write-Host "Setted variable"
                azurePowerShellVersion: 'LatestVersion'
                pwsh: true
            - task: CmdLine@2
              inputs:
                script: |
                  echo $(Updatecredentials.sdkVersion)
                  echo Hello world
